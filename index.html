<!doctype html>
<html>
<head>
    <title>frb.js</title>
<style type="text/css" media="screen">
    body { width: 2000px; }
    #editor { 
        /*float:right;*/
        width:600px;
        height:600px;
    }
    #canvas {
        float:left;
        /*margin-left: 600px;*
    }
</style>
</head>

<body>
<h1 id="title">FRB.js</h1>
<p id="description"></p>
<canvas id="canvas" width="800" height="600"></canvas>
<div id="editor"></div>

<script src="jquery-1.7.1.min.js" type="text/javascript"></script>
<script src="frb.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.2.6/ace.js" type="text/javascript" charset="utf-8"></script>
<script>

    // set up the editor
    var editor = ace.edit("editor");
    editor.setTheme("ace/theme/monokai");
    editor.getSession().setMode("ace/mode/javascript");

    // set up the compilation thread:
    var compileWorker = new Worker('compile-thread.js');

    var failedEvent = function(err) {
        console.log(err);
    };

    compileWorker.addEventListener('message', function(e) {
        // Compilation finished ... now update the UI
        var result = e.data;

        if (result.failed) {
            failedEvent(result.message);
            return;
        }

        try {
            if (result.shouldReset) {
                window.game.SpriteManager.reset();
                eval("(" + result.initFunction + ")")(window.game);
            }
            window.game.updateFunction = eval("(" + result.updateFunction + ")");
        }
        catch (err) {
            failedEvent(err.message);
        }
    }, false);

var getScript = function(scriptName) {
    var dataUrl = "api/"+ scriptName +".js";
    var scriptUrl = "api/"+ scriptName +"-source.js";

    $.ajax({
      url: scriptUrl,
      success: function(result) { 
            eval(result);
            editor.setValue(result);
        },
        error: function(jqXHR, textStatus, errorThrown) { 
            alert(textStatus);
        },
      dataType: "text"
    });

    $.ajax({
      url: dataUrl,
      success: function(result) { 
            var data = eval("(" + result + ")");
            $("#title").text(data.title);
            $("#description").html(data.description);
        },
        error: function(jqXHR, textStatus, errorThrown) { 
            alert(textStatus);
        },
      dataType: "text"
    });

};

var scriptName = "emitter";
if (location.hash && location.hash.length > 0) {
    scriptName = location.hash.substring(1, location.hash.length);
}
getScript(scriptName);


editor.getSession().on('change', function() {
    // send a message to the compilation thread
    var script  = editor.getValue();
    compileWorker.postMessage(script);
});
</script>

</body>
</html>

















